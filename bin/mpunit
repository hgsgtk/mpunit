#!/usr/bin/env php
<?php declare(strict_types=1);

use MPUnit\TestResult;

require __DIR__ . '/../vendor/autoload.php';

// When assertion is failed, throw AssertError
ini_set('assert.exception', '1');

// When assertion is failed, omit PHP warning
assert_options(ASSERT_WARNING, '0');

// Set callback function
$testResult = new TestResult();

echo 'Mini PHP xUnit Testing.' . PHP_EOL . PHP_EOL;

$argv = $_SERVER['argv'];
$testDir = $argv[1] ?? 'tests';

// TODO if not found, print no tests here.
chdir($testDir);

foreach (glob('*_test.php') as $file) {
    try {
        include $file;
        $testResult->addSuccess();
        echo '.';
    } catch (\AssertionError $e) {
        $testResult->addFailure(
            $e->getFile(),
            $e->getLine(),
            $e->getMessage()
        );
        echo 'F';
    }
}

echo PHP_EOL . PHP_EOL;

exit($testResult->endTest());
